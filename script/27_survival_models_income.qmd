---
title: ""
format:
  html:
    embed-resources: true
    page-layout: full
    grid:
      margin-width: 100px
author: Daniel Väisänen
editor: source
toc: true
execute:
  warning: false
  echo: true
  eval: false
---


# Libraries
```{r}
library(flexsurv)
library(tidyverse)
library(marginaleffects)
library(survival)

```


# data

```{r}
source(here::here("script", "01_data_source_file.R"))
source(here::here("script", "02_functions_source_file.R"))
```

# fit
income effect is conditional on treatment status
```{r}
fit_income = coxph(
  Surv(risk_time_art_10yrs, risk_art_flag_10yrs) ~
    treated *
      IncomeLevel_CSFVI +
      birth_cohort +
      Age +
      Sex +
      comorbidity +
      cvd_art_before_HPA_flag,
  data = data_cvd
)


```

```{r}

```


```{r}
broom = broom::tidy(fit_income, exponentiate = TRUE, conf.int = TRUE)
```



```{r}
# marginal effects with packGE MARGINALEFFECTS
hr_tbl_income <- fit_income |>
  avg_comparisons(
    # average contrasts
    variables = "treated", # focal variable
    by = "IncomeLevel_CSFVI",
    type = "lp", # linear predictor = log-hazard
    transform = "exp"
  )

hr_tbl_income
```

    Term IncomeLevel_CSFVI Estimate Pr(>|z|)    S 2.5 % 97.5 %
 treated          <60%        0.807   0.0678  3.9 0.641  1.016
 treated          60–79%      0.882   0.0377  4.7 0.784  0.993
 treated          80–119%     0.880   <0.001 27.1 0.842  0.919
 treated          120–199%    0.904   <0.001 19.6 0.868  0.942
 treated          ≥200%       0.931   0.0747  3.7 0.861  1.007

# Income effect averaged across treatment groups
```{r}

hr_income_effect <- fit_income |>
  avg_comparisons(
    variables = "IncomeLevel_CSFVI",
    type = "lp",
    transform = "exp"
  )


```

        Contrast Estimate Pr(>|z|)     S 2.5 % 97.5 %
 60–79% - <60%      1.061    0.068   3.9 0.996  1.130
 80–119% - <60%     0.897   <0.001  13.0 0.849  0.948
 120–199% - <60%    0.752   <0.001  76.4 0.711  0.795
 ≥200% - <60%       0.627   <0.001 156.5 0.589  0.668


# main model estimates (no interaction)
```{r}
fit_income_main = coxph(
  Surv(risk_time_art_10yrs, risk_art_flag_10yrs) ~
    IncomeLevel_CSFVI +
      birth_cohort +
      Age +
      Sex +
      comorbidity +
      cvd_art_before_HPA_flag,
  data = data_cvd
)


fit_main = broom::tidy(fit_income_main, exponentiate = TRUE, conf.int = TRUE)
fit_main
```
